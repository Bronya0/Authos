<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authos - 权限管理系统</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: #f5f5f5;
        color: #333;
      }

      .container {
        display: flex;
        height: 100vh;
      }

      .sidebar {
        width: 250px;
        background-color: #2c3e50;
        color: white;
        padding: 20px;
      }

      .sidebar h2 {
        margin-bottom: 30px;
        text-align: center;
        color: #ecf0f1;
      }

      .sidebar ul {
        list-style: none;
      }

      .sidebar li {
        margin-bottom: 10px;
      }

      .sidebar a {
        color: #bdc3c7;
        text-decoration: none;
        display: block;
        padding: 10px 15px;
        border-radius: 5px;
        transition: all 0.3s;
      }

      .sidebar a:hover,
      .sidebar a.active {
        background-color: #34495e;
        color: white;
      }

      .main-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }

      .header {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
      }

      .btn-xs {
        padding: 3px 8px;
        font-size: 11px;
      }

      .btn-primary {
        background-color: #3498db;
        color: white;
      }

      .btn-primary:hover {
        background-color: #2980b9;
      }

      .btn-success {
        background-color: #27ae60;
        color: white;
      }

      .btn-success:hover {
        background-color: #229954;
      }

      .btn-danger {
        background-color: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background-color: #c0392b;
      }

      .btn-warning {
        background-color: #f39c12;
        color: white;
      }

      .btn-warning:hover {
        background-color: #d68910;
      }

      .card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .table th,
      .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .table th {
        background-color: #f8f9fa;
        font-weight: 600;
      }

      .table tr:hover {
        background-color: #f8f9fa;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .form-control:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: relative;
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .close {
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }

      .close:hover {
        color: #333;
      }

      .alert {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }

      .alert-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .alert-error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .login-container {
        max-width: 400px;
        margin: 100px auto;
        padding: 40px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .login-container h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #2c3e50;
      }

      .hidden {
        display: none;
      }

      .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .badge-success {
        background-color: #27ae60;
        color: white;
      }

      .badge-danger {
        background-color: #e74c3c;
        color: white;
      }

      .badge-primary {
        background-color: #3498db;
        color: white;
      }

      .badge-warning {
        background-color: #f39c12;
        color: white;
      }

      .badge-secondary {
        background-color: #95a5a6;
        color: white;
      }

      .tree {
        list-style: none;
        padding-left: 20px;
      }

      .tree-item {
        margin: 5px 0;
      }

      .tree-toggle {
        cursor: pointer;
        margin-right: 5px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .role-selection {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        background-color: #f9f9f9;
        max-height: 200px;
        overflow-y: auto;
      }

      /* 自定义滚动条样式 */
      .role-selection::-webkit-scrollbar {
        width: 8px;
      }

      .role-selection::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .role-selection::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      .role-selection::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      .role-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        padding: 5px;
        border-radius: 3px;
        transition: background-color 0.2s;
      }

      .role-item:hover {
        background-color: #e9ecef;
      }

      .role-item:last-child {
        margin-bottom: 0;
      }

      .role-item input[type="checkbox"] {
        margin-right: 8px;
      }

      .role-item input[type="checkbox"]:checked + label {
        color: #3498db;
        font-weight: 500;
      }

      .role-item label {
        margin-bottom: 0;
        cursor: pointer;
        flex: 1;
        transition: color 0.2s, font-weight 0.2s;
      }
    </style>
  </head>
  <body>
    <!-- 登录页面 -->
    <div id="loginPage" class="login-container">
      <h2>Authos 权限管理系统</h2>
      <form id="loginForm">
        <div class="form-group">
          <label for="username">用户名</label>
          <input type="text" id="username" class="form-control" required />
        </div>
        <div class="form-group">
          <label for="password">密码</label>
          <input type="password" id="password" class="form-control" required />
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%">
          登录
        </button>
      </form>
    </div>

    <!-- 主页面 -->
    <div id="mainPage" class="container hidden">
      <div class="sidebar">
        <h2>Authos</h2>
        <ul>
          <li>
            <a href="#" data-page="dashboard" class="nav-link active">仪表盘</a>
          </li>
          <li><a href="#" data-page="users" class="nav-link">用户管理</a></li>
          <li><a href="#" data-page="roles" class="nav-link">角色管理</a></li>
          <li><a href="#" data-page="menus" class="nav-link">菜单管理</a></li>
          <li>
            <a href="#" data-page="permissions" class="nav-link">权限配置</a>
          </li>
          <li>
            <a href="#" data-page="external-apps" class="nav-link"
              >外部应用管理</a
            >
          </li>
          <li>
            <a href="#" data-page="external-users" class="nav-link"
              >外部用户管理</a
            >
          </li>
          <li>
            <a href="#" data-page="api-docs" class="nav-link">接口文档</a>
          </li>
        </ul>
      </div>

      <div class="main-content">
        <div class="header">
          <h1 id="pageTitle">仪表盘</h1>
          <div>
            <span id="currentUser" style="margin-right: 20px"></span>
            <button id="refreshBtn" class="btn btn-primary">刷新</button>
            <button
              id="logoutBtn"
              class="btn btn-danger"
              style="margin-left: 10px"
            >
              退出登录
            </button>
          </div>
        </div>

        <div id="content">
          <!-- 动态内容将在这里显示 -->
        </div>
      </div>
    </div>

    <!-- 模态框 -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">标题</h3>
          <span class="close">&times;</span>
        </div>
        <div id="modalBody">
          <!-- 模态框内容 -->
        </div>
      </div>
    </div>

    <script>
      // API基础URL
      const API_BASE = "/api/v1";

      // 全局变量
      let currentToken = localStorage.getItem("token");
      let currentUser = null;

      // 初始化
      document.addEventListener("DOMContentLoaded", function () {
        if (currentToken) {
          showMainPage();
        } else {
          showLoginPage();
        }

        // 绑定事件
        bindEvents();
      });

      // 绑定事件
      function bindEvents() {
        // 登录表单
        document
          .getElementById("loginForm")
          .addEventListener("submit", handleLogin);

        // 导航链接
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const page = this.dataset.page;
            if (page) {
              navigateTo(page);
            }
          });
        });

        // 退出登录
        document
          .getElementById("logoutBtn")
          .addEventListener("click", handleLogout);

        // 刷新按钮
        document
          .getElementById("refreshBtn")
          .addEventListener("click", refreshCurrentPage);

        // 模态框关闭
        document.querySelector(".close").addEventListener("click", closeModal);
        document
          .getElementById("modal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              closeModal();
            }
          });
      }

      // 显示登录页面
      function showLoginPage() {
        document.getElementById("loginPage").classList.remove("hidden");
        document.getElementById("mainPage").classList.add("hidden");
      }

      // 显示主页面
      function showMainPage() {
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("mainPage").classList.remove("hidden");
        loadCurrentUser();
        navigateTo("dashboard");
      }

      // 处理登录
      async function handleLogin(e) {
        e.preventDefault();

        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        try {
          const response = await fetch(`/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (response.ok) {
            currentToken = data.token;
            localStorage.setItem("token", currentToken);
            // 存储用户信息
            currentUser = data.user;
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            showMainPage();
          } else {
            alert(data.message || "登录失败");
          }
        } catch (error) {
          alert("登录请求失败: " + error.message);
        }
      }

      // 处理退出登录
      function handleLogout() {
        if (confirm("确定要退出登录吗？")) {
          currentToken = null;
          localStorage.removeItem("token");
          localStorage.removeItem("currentUser");
          currentUser = null;
          showLoginPage();
        }
      }

      // 加载当前用户信息
      function loadCurrentUser() {
        if (!currentToken) {
          console.log("No token available for loadCurrentUser");
          return;
        }

        // 从localStorage获取用户信息
        const userStr = localStorage.getItem("currentUser");
        if (userStr) {
          try {
            currentUser = JSON.parse(userStr);
            document.getElementById("currentUser").textContent =
              currentUser.username;
            console.log(
              "Current user loaded successfully:",
              currentUser.username
            );
          } catch (error) {
            console.error(
              "Failed to parse user info from localStorage:",
              error
            );
          }
        }
      }

      // 导航到指定页面
      function navigateTo(page) {
        // 更新导航状态
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("active");
        });
        document.querySelector(`[data-page="${page}"]`).classList.add("active");

        // 更新页面标题
        const titles = {
          dashboard: "仪表盘",
          users: "用户管理",
          roles: "角色管理",
          menus: "菜单管理",
          permissions: "权限配置",
          "external-apps": "外部应用管理",
          "external-users": "外部用户管理",
          "api-docs": "接口文档",
        };
        document.getElementById("pageTitle").textContent = titles[page];

        // 加载页面内容
        loadPageContent(page);
      }

      // 刷新当前页面
      function refreshCurrentPage() {
        const activeLink = document.querySelector(".nav-link.active");
        if (activeLink) {
          const page = activeLink.dataset.page;
          loadPageContent(page);
        }
      }

      // 加载页面内容
      async function loadPageContent(page) {
        const content = document.getElementById("content");
        content.innerHTML = '<div class="loading">加载中...</div>';

        switch (page) {
          case "dashboard":
            await loadDashboard();
            break;
          case "users":
            await loadUsersPage();
            break;
          case "roles":
            await loadRolesPage();
            break;
          case "menus":
            await loadMenusPage();
            break;
          case "permissions":
            await loadPermissionsPage();
            break;
          case "external-apps":
            await loadExternalAppsPage();
            break;
          case "external-users":
            await loadExternalUsersPage();
            break;
          case "api-docs":
            await loadApiDocsPage();
            break;
        }
      }

      // 加载仪表盘
      async function loadDashboard() {
        const content = document.getElementById("content");
        content.innerHTML = `
                <div class="card">
                    <h3>系统概览</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="background-color: #3498db; color: white; padding: 20px; border-radius: 8px;">
                            <h4>用户总数</h4>
                            <p style="font-size: 24px; font-weight: bold;" id="userCount">-</p>
                        </div>
                        <div style="background-color: #27ae60; color: white; padding: 20px; border-radius: 8px;">
                            <h4>角色总数</h4>
                            <p style="font-size: 24px; font-weight: bold;" id="roleCount">-</p>
                        </div>
                        <div style="background-color: #f39c12; color: white; padding: 20px; border-radius: 8px;">
                            <h4>菜单总数</h4>
                            <p style="font-size: 24px; font-weight: bold;" id="menuCount">-</p>
                        </div>
                    </div>
                </div>
            `;

        // 加载统计数据
        try {
          const [users, roles, menus] = await Promise.all([
            fetchData("/users"),
            fetchData("/roles"),
            fetchData("/menus"),
          ]);

          document.getElementById("userCount").textContent = users.length;
          document.getElementById("roleCount").textContent = roles.length;
          document.getElementById("menuCount").textContent = menus.length;
        } catch (error) {
          console.error("加载统计数据失败:", error);
        }
      }

      // 加载用户管理页面
      async function loadUsersPage() {
        const content = document.getElementById("content");
        content.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>用户列表</h3>
                        <button class="btn btn-success" onclick="showAddUserModal()">添加用户</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用户名</th>
                                <th>状态</th>
                                <th>角色</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr><td colspan="6" class="loading">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            `;

        await loadUsers();
      }

      // 加载用户列表
      async function loadUsers() {
        try {
          const users = await fetchData("/users");
          const roles = await fetchData("/roles");

          const tbody = document.getElementById("userTableBody");
          tbody.innerHTML = users
            .map(
              (user) => `
                    <tr>
                        <td>${user.ID || user.id}</td>
                        <td>${user.username}</td>
                        <td>
                            <span class="badge ${
                              user.status === 1
                                ? "badge-success"
                                : "badge-danger"
                            }">
                                ${user.status === 1 ? "启用" : "禁用"}
                            </span>
                        </td>
                        <td>${
                          user.roles
                            ? user.roles.map((r) => r.name).join(", ")
                            : "-"
                        }</td>
                        <td>${formatDate(user.CreatedAt || user.createdAt)}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="showEditUserModal(${
                              user.ID || user.id
                            })">编辑</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${
                              user.ID || user.id
                            })">删除</button>
                        </td>
                    </tr>
                `
            )
            .join("");
        } catch (error) {
          document.getElementById("userTableBody").innerHTML =
            '<tr><td colspan="6" style="text-align: center; color: red;">加载失败</td></tr>';
        }
      }

      // 显示添加用户模态框
      function showAddUserModal() {
        showModal(
          "添加用户",
          `
                <form id="userForm">
                    <div class="form-group">
                        <label>用户名</label>
                        <input type="text" id="userUsername" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>密码</label>
                        <input type="password" id="userPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>状态</label>
                        <select id="userStatus" class="form-control">
                            <option value="1">启用</option>
                            <option value="0">禁用</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>角色</label>
                        <div id="roleCheckboxes"></div>
                    </div>
                    <button type="submit" class="btn btn-success">保存</button>
                </form>
            `
        );

        loadRolesForCheckboxes();

        document
          .getElementById("userForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            await createUser();
          });
      }

      // 显示编辑用户模态框
      async function showEditUserModal(userId) {
        try {
          const user = await fetchData(`/users/${userId}`);
          const roles = await fetchData("/roles");

          showModal(
            "编辑用户",
            `
                    <form id="editUserForm">
                        <div class="form-group">
                            <label>用户名</label>
                            <input type="text" id="editUserUsername" class="form-control" value="${
                              user.username
                            }" required>
                        </div>
                        <div class="form-group">
                            <label>新密码（留空则不修改）</label>
                            <input type="password" id="editUserPassword" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>状态</label>
                            <select id="editUserStatus" class="form-control">
                                <option value="1" ${
                                  user.status === 1 ? "selected" : ""
                                }>启用</option>
                                <option value="0" ${
                                  user.status === 0 ? "selected" : ""
                                }>禁用</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>角色</label>
                            <div id="editRoleCheckboxes"></div>
                        </div>
                        <button type="submit" class="btn btn-success">保存</button>
                    </form>
                `
          );

          // 加载角色复选框
          const checkboxesHtml = `
            <div class="role-selection">
              ${roles
                .map(
                  (role) => `
                    <div class="role-item">
                      <input type="checkbox" name="roles" value="${
                        role.id
                      }" id="edit-role-${role.id}"
                          ${
                            user.roles &&
                            user.roles.some((r) => r.id === role.id)
                              ? "checked"
                              : ""
                          }>
                      <label for="edit-role-${role.id}">${role.name}</label>
                    </div>
                  `
                )
                .join("")}
            </div>
          `;
          document.getElementById("editRoleCheckboxes").innerHTML =
            checkboxesHtml;

          document
            .getElementById("editUserForm")
            .addEventListener("submit", async function (e) {
              e.preventDefault();
              await updateUser(userId);
            });
        } catch (error) {
          alert("加载用户信息失败: " + error.message);
        }
      }

      // 创建用户
      async function createUser() {
        const data = {
          username: document.getElementById("userUsername").value,
          password: document.getElementById("userPassword").value,
          status: parseInt(document.getElementById("userStatus").value),
          roleIds: Array.from(
            document.querySelectorAll("#roleCheckboxes input:checked")
          ).map((cb) => parseInt(cb.value)),
        };

        try {
          await fetchData("/users", "POST", data);
          closeModal();
          loadUsers();
          showAlert("用户创建成功", "success");
        } catch (error) {
          alert("创建用户失败: " + error.message);
        }
      }

      // 更新用户
      async function updateUser(userId) {
        const data = {
          username: document.getElementById("editUserUsername").value,
          status: parseInt(document.getElementById("editUserStatus").value),
          roleIds: Array.from(
            document.querySelectorAll("#editRoleCheckboxes input:checked")
          ).map((cb) => parseInt(cb.value)),
        };

        const password = document.getElementById("editUserPassword").value;
        if (password) {
          data.password = password;
        }

        try {
          await fetchData(`/users/${userId}`, "PUT", data);
          closeModal();
          loadUsers();
          showAlert("用户更新成功", "success");
        } catch (error) {
          alert("更新用户失败: " + error.message);
        }
      }

      // 删除用户
      async function deleteUser(userId) {
        if (!confirm("确定要删除这个用户吗？")) return;

        try {
          await fetchData(`/users/${userId}`, "DELETE");
          loadUsers();
          showAlert("用户删除成功", "success");
        } catch (error) {
          alert("删除用户失败: " + error.message);
        }
      }

      // 加载权限配置页面
      async function loadPermissionsPage() {
        const content = document.getElementById("content");
        content.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>URL接口权限配置</h3>
                        <button class="btn btn-success" onclick="showAddPermissionModal()">添加权限</button>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group" style="display: flex; gap: 15px; align-items: end;">
                            <div style="flex: 1;">
                                <label>权限路径</label>
                                <input type="text" id="quickPermissionPath" class="form-control" placeholder="例如: /api/v1/users">
                            </div>
                            <div style="width: 150px;">
                                <label>HTTP方法</label>
                                <select id="quickPermissionMethod" class="form-control">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                    <option value="*">所有方法</option>
                                </select>
                            </div>
                            <div style="width: 200px;">
                                <label>描述</label>
                                <input type="text" id="quickPermissionDesc" class="form-control" placeholder="权限描述">
                            </div>
                            <div>
                                <button class="btn btn-primary" onclick="quickAddPermission()">快速添加</button>
                            </div>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>路径</th>
                                <th>方法</th>
                                <th>描述</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="permissionTableBody">
                            <tr><td colspan="5" class="loading">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            `;

        await loadPermissions();
      }

      // 加载权限列表
      async function loadPermissions() {
        try {
          // 这里需要从后端获取权限列表，目前使用模拟数据
          const permissions = await fetchData("/permissions");

          const tbody = document.getElementById("permissionTableBody");
          tbody.innerHTML = permissions
            .map(
              (permission) => `
                    <tr>
                        <td>${permission.obj}</td>
                        <td><span class="badge badge-${getMethodBadgeClass(
                          permission.act
                        )}">${permission.act}</span></td>
                        <td>${permission.description || ""}</td>
                        <td>${formatDate(permission.createdAt)}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="showPermissionRolesModal('${
                              permission.obj
                            }', '${permission.act}')">查看角色</button>
                            <button class="btn btn-danger btn-sm" onclick="deletePermission('${
                              permission.obj
                            }', '${permission.act}')">删除</button>
                        </td>
                    </tr>
                `
            )
            .join("");
        } catch (error) {
          document.getElementById("permissionTableBody").innerHTML =
            '<tr><td colspan="5" style="text-align: center; color: red;">加载失败</td></tr>';
        }
      }

      // 获取HTTP方法的徽章样式
      function getMethodBadgeClass(method) {
        switch (method) {
          case "GET":
            return "success";
          case "POST":
            return "primary";
          case "PUT":
            return "warning";
          case "DELETE":
            return "danger";
          default:
            return "secondary";
        }
      }

      // 快速添加权限
      async function quickAddPermission() {
        const path = document.getElementById("quickPermissionPath").value;
        const method = document.getElementById("quickPermissionMethod").value;
        const description = document.getElementById(
          "quickPermissionDesc"
        ).value;

        if (!path) {
          alert("请输入权限路径");
          return;
        }

        try {
          await fetchData("/permissions", "POST", {
            obj: path,
            act: method,
            description: description,
          });

          // 清空表单
          document.getElementById("quickPermissionPath").value = "";
          document.getElementById("quickPermissionMethod").value = "GET";
          document.getElementById("quickPermissionDesc").value = "";

          // 重新加载权限列表
          await loadPermissions();
          showAlert("权限添加成功", "success");
        } catch (error) {
          alert("添加权限失败: " + error.message);
        }
      }

      // 显示添加权限模态框
      function showAddPermissionModal() {
        showModal(
          "添加权限",
          `
                <form id="permissionForm">
                    <div class="form-group">
                        <label>权限路径</label>
                        <input type="text" id="permissionPath" class="form-control" placeholder="例如: /api/v1/users" required>
                        <small class="form-text text-muted">支持通配符，如 /api/v1/users/* 匹配所有用户相关接口</small>
                    </div>
                    <div class="form-group">
                        <label>HTTP方法</label>
                        <select id="permissionMethod" class="form-control">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                            <option value="*">所有方法</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>描述</label>
                        <input type="text" id="permissionDescription" class="form-control" placeholder="权限描述">
                    </div>
                    <button type="submit" class="btn btn-success">保存</button>
                </form>
            `
        );

        document
          .getElementById("permissionForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            await quickAddPermission();
            closeModal();
          });
      }

      // 显示权限关联的角色
      async function showPermissionRolesModal(obj, act) {
        try {
          const roles = await fetchData(
            `/permissions/roles?obj=${encodeURIComponent(
              obj
            )}&act=${encodeURIComponent(act)}`
          );

          showModal(
            `权限关联角色 - ${obj}:${act}`,
            `
                <div class="form-group">
                    <label>已关联的角色</label>
                    <div id="associatedRoles">
                        ${
                          roles.length === 0
                            ? "<p>暂无角色关联此权限</p>"
                            : roles
                                .map(
                                  (role) => `
                            <div class="role-item">
                                <span class="badge badge-info">${role.name}</span>
                            </div>
                          `
                                )
                                .join("")
                        }
                    </div>
                </div>
                <div class="form-group">
                    <label>可关联的角色</label>
                    <div id="availableRoles"></div>
                </div>
                <button class="btn btn-success" onclick="associateRolesToPermission('${obj}', '${act}')">保存关联</button>
            `
          );

          // 加载所有角色
          const allRoles = await fetchData("/roles");
          const associatedRoleIds = roles.map((role) => role.id);
          const availableRoles = allRoles.filter(
            (role) => !associatedRoleIds.includes(role.id)
          );

          document.getElementById("availableRoles").innerHTML = availableRoles
            .map(
              (role) => `
            <div class="role-item">
              <input type="checkbox" id="role_${role.id}" value="${role.id}">
              <label for="role_${role.id}">${role.name} (${role.code})</label>
            </div>
          `
            )
            .join("");
        } catch (error) {
          alert("加载权限角色信息失败: " + error.message);
        }
      }

      // 关联角色到权限
      async function associateRolesToPermission(obj, act) {
        const selectedRoleIds = Array.from(
          document.querySelectorAll("#availableRoles input:checked")
        ).map((cb) => parseInt(cb.value));

        if (selectedRoleIds.length === 0) {
          alert("请选择要关联的角色");
          return;
        }

        try {
          for (const roleId of selectedRoleIds) {
            await fetchData(`/roles/${roleId}/permissions`, "POST", [
              {
                obj: obj,
                act: act,
              },
            ]);
          }

          closeModal();
          showAlert("角色关联成功", "success");
        } catch (error) {
          alert("角色关联失败: " + error.message);
        }
      }

      // 删除权限
      async function deletePermission(obj, act) {
        if (!confirm(`确定要删除权限 ${obj}:${act} 吗？`)) return;

        try {
          await fetchData(
            `/permissions?obj=${encodeURIComponent(
              obj
            )}&act=${encodeURIComponent(act)}`,
            "DELETE"
          );
          await loadPermissions();
          showAlert("权限删除成功", "success");
        } catch (error) {
          alert("删除权限失败: " + error.message);
        }
      }

      // 加载角色管理页面
      async function loadRolesPage() {
        const content = document.getElementById("content");
        content.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>角色列表</h3>
                        <button class="btn btn-success" onclick="showAddRoleModal()">添加角色</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>编码</th>
                                <th>名称</th>
                                <th>排序</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="roleTableBody">
                            <tr><td colspan="6" class="loading">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            `;

        await loadRoles();
      }

      // 加载角色列表
      async function loadRoles() {
        try {
          const roles = await fetchData("/roles");

          const tbody = document.getElementById("roleTableBody");
          tbody.innerHTML = roles
            .map(
              (role) => `
                    <tr>
                        <td>${role.ID || role.id}</td>
                        <td>${role.code}</td>
                        <td>${role.name}</td>
                        <td>${role.sort}</td>
                        <td>${formatDate(role.CreatedAt || role.createdAt)}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="showEditRoleModal(${
                              role.ID || role.id
                            })">编辑</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteRole(${
                              role.ID || role.id
                            })">删除</button>
                            <button class="btn btn-info btn-sm" onclick="showRoleMenusModal(${
                              role.ID || role.id
                            })">菜单权限</button>
                            <button class="btn btn-primary btn-sm" onclick="showRoleApiPermissionsModal(${
                              role.ID || role.id
                            })">接口权限</button>
                        </td>
                    </tr>
                `
            )
            .join("");
        } catch (error) {
          document.getElementById("roleTableBody").innerHTML =
            '<tr><td colspan="6" style="text-align: center; color: red;">加载失败</td></tr>';
        }
      }

      // 显示添加角色模态框
      function showAddRoleModal() {
        showModal(
          "添加角色",
          `
                <form id="roleForm">
                    <div class="form-group">
                        <label>编码</label>
                        <input type="text" id="roleCode" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>名称</label>
                        <input type="text" id="roleName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>排序</label>
                        <input type="number" id="roleSort" class="form-control" value="0">
                    </div>
                    <button type="submit" class="btn btn-success">保存</button>
                </form>
            `
        );

        document
          .getElementById("roleForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            await createRole();
          });
      }

      // 显示编辑角色模态框
      async function showEditRoleModal(roleId) {
        try {
          const role = await fetchData(`/roles/${roleId}`);

          showModal(
            "编辑角色",
            `
                    <form id="editRoleForm">
                        <div class="form-group">
                            <label>编码</label>
                            <input type="text" id="editRoleCode" class="form-control" value="${role.code}" required>
                        </div>
                        <div class="form-group">
                            <label>名称</label>
                            <input type="text" id="editRoleName" class="form-control" value="${role.name}" required>
                        </div>
                        <div class="form-group">
                            <label>排序</label>
                            <input type="number" id="editRoleSort" class="form-control" value="${role.sort}">
                        </div>
                        <button type="submit" class="btn btn-success">保存</button>
                    </form>
                `
          );

          document
            .getElementById("editRoleForm")
            .addEventListener("submit", async function (e) {
              e.preventDefault();
              await updateRole(roleId);
            });
        } catch (error) {
          alert("加载角色信息失败: " + error.message);
        }
      }

      // 显示角色权限模态框
      // 显示角色菜单权限模态框
      async function showRoleMenusModal(roleId) {
        try {
          const role = await fetchData(`/roles/${roleId}`);
          const menus = await fetchData("/menus");

          showModal(
            `角色菜单权限 - ${role.name}`,
            `
                    <form id="roleMenusForm">
                        <div class="form-group">
                            <label>菜单权限</label>
                            <div id="menuPermissions"></div>
                        </div>
                        <button type="submit" class="btn btn-success">保存</button>
                    </form>
                `
          );

          // 渲染菜单权限树
          renderMenuTree(menus, role.menus || []);

          document
            .getElementById("roleMenusForm")
            .addEventListener("submit", async function (e) {
              e.preventDefault();
              await updateRoleMenus(roleId);
            });
        } catch (error) {
          alert("加载菜单权限信息失败: " + error.message);
        }
      }

      // 显示角色接口权限模态框
      async function showRoleApiPermissionsModal(roleId) {
        try {
          const role = await fetchData(`/roles/${roleId}`);
          const permissions = await fetchData("/permissions");

          showModal(
            `角色接口权限 - ${role.name}`,
            `
                    <form id="roleApiPermissionsForm">
                        <div class="form-group">
                            <label>接口权限</label>
                            <div id="apiPermissions"></div>
                        </div>
                        <button type="submit" class="btn btn-success">保存</button>
                    </form>
                `
          );

          // 渲染接口权限
          renderApiPermissionsList(permissions, role.permissions || []);

          document
            .getElementById("roleApiPermissionsForm")
            .addEventListener("submit", async function (e) {
              e.preventDefault();
              await updateRoleApiPermissions(roleId);
            });
        } catch (error) {
          alert("加载接口权限信息失败: " + error.message);
        }
      }

      // 原始函数保留，以防其他地方还在使用
      async function showRolePermissionsModal(roleId) {
        try {
          const role = await fetchData(`/roles/${roleId}`);
          const menus = await fetchData("/menus");

          showModal(
            `角色权限 - ${role.name}`,
            `
                    <form id="rolePermissionsForm">
                        <div class="form-group">
                            <label>菜单权限</label>
                            <div id="menuPermissions"></div>
                        </div>
                        <div class="form-group">
                            <label>接口权限</label>
                            <div id="apiPermissions"></div>
                        </div>
                        <button type="submit" class="btn btn-success">保存</button>
                    </form>
                `
          );

          // 渲染菜单权限树
          renderMenuTree(menus, role.menus || []);

          // 渲染接口权限
          renderApiPermissions(role.permissions || []);

          document
            .getElementById("rolePermissionsForm")
            .addEventListener("submit", async function (e) {
              e.preventDefault();
              await updateRolePermissions(roleId);
            });
        } catch (error) {
          alert("加载权限信息失败: " + error.message);
        }
      }

      // 创建角色
      async function createRole() {
        const data = {
          code: document.getElementById("roleCode").value,
          name: document.getElementById("roleName").value,
          sort: parseInt(document.getElementById("roleSort").value),
        };

        try {
          await fetchData("/roles", "POST", data);
          closeModal();
          loadRoles();
          showAlert("角色创建成功", "success");
        } catch (error) {
          alert("创建角色失败: " + error.message);
        }
      }

      // 更新角色
      async function updateRole(roleId) {
        const data = {
          code: document.getElementById("editRoleCode").value,
          name: document.getElementById("editRoleName").value,
          sort: parseInt(document.getElementById("editRoleSort").value),
        };

        try {
          await fetchData(`/roles/${roleId}`, "PUT", data);
          closeModal();
          loadRoles();
          showAlert("角色更新成功", "success");
        } catch (error) {
          alert("更新角色失败: " + error.message);
        }
      }

      // 更新角色菜单权限
      async function updateRoleMenus(roleId) {
        const menuIds = Array.from(
          document.querySelectorAll("#menuPermissions input:checked")
        ).map((cb) => parseInt(cb.value));

        try {
          await fetchData(`/roles/${roleId}/menus`, "PUT", { menuIds });
          closeModal();
          showAlert("菜单权限更新成功", "success");
        } catch (error) {
          alert("更新菜单权限失败: " + error.message);
        }
      }

      // 更新角色接口权限
      async function updateRoleApiPermissions(roleId) {
        const permissions = Array.from(
          document.querySelectorAll("#apiPermissions input:checked")
        ).map((cb) => cb.value);

        try {
          await fetchData(`/roles/${roleId}/permissions`, "PUT", {
            permissions,
          });
          closeModal();
          showAlert("接口权限更新成功", "success");
        } catch (error) {
          alert("更新接口权限失败: " + error.message);
        }
      }

      // 渲染接口权限列表
      function renderApiPermissionsList(permissions, selectedPermissions = []) {
        if (!permissions || permissions.length === 0) {
          document.getElementById("apiPermissions").innerHTML =
            '<p style="color: #666;">暂无接口权限</p>';
          return;
        }

        // 按照路径分组
        const grouped = {};
        permissions.forEach((perm) => {
          const path = perm.obj;
          if (!grouped[path]) {
            grouped[path] = [];
          }
          grouped[path].push(perm);
        });

        let html = "";
        
        // 添加全局全选/取消按钮
        html += `
          <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: bold;">批量操作</span>
              <div>
                <button type="button" class="btn btn-xs btn-primary" onclick="toggleAllPermissions(true)">全选所有</button>
                <button type="button" class="btn btn-xs btn-secondary" onclick="toggleAllPermissions(false)">取消所有</button>
              </div>
            </div>
          </div>
        `;
        
        Object.keys(grouped).forEach((path) => {
          const pathId = path.replace(/[^a-zA-Z0-9]/g, '_');
          const allChecked = grouped[path].every(perm => 
            selectedPermissions.some(p => 
              (p.obj === perm.obj && p.act === perm.act) || p === perm.obj + ":" + perm.act
            )
          );
          
          html += `<div style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h4 style="margin: 0; color: #333;">${path}</h4>
              <div>
                <button type="button" class="btn btn-xs btn-primary" onclick="togglePathPermissions('${pathId}', true)">全选</button>
                <button type="button" class="btn btn-xs btn-secondary" onclick="togglePathPermissions('${pathId}', false)">取消</button>
              </div>
            </div>
            <div id="path_${pathId}">`;

          grouped[path].forEach((perm) => {
            const isChecked = selectedPermissions.some(
              (p) =>
                (p.obj === perm.obj && p.act === perm.act) ||
                p === perm.obj + ":" + perm.act
            );
            html += `
              <label style="display: block; margin: 5px 0; padding-left: 20px;">
                <input type="checkbox" name="permissions" value="${perm.obj}:${
              perm.act
            }" data-path="${pathId}"
                    ${isChecked ? "checked" : ""}>
                <span class="badge badge-${getMethodBadgeClass(perm.act)}">${
              perm.act
            }</span>
                ${perm.description || ""}
              </label>
            `;
          });

          html += `</div></div>`;
        });

        document.getElementById("apiPermissions").innerHTML = html;
      }

      // 切换路径权限选择
      function togglePathPermissions(pathId, selectAll) {
        const checkboxes = document.querySelectorAll(`input[data-path="${pathId}"]`);
        checkboxes.forEach(checkbox => {
          checkbox.checked = selectAll;
        });
      }

      // 切换所有权限选择
      function toggleAllPermissions(selectAll) {
        const checkboxes = document.querySelectorAll('input[name="permissions"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = selectAll;
        });
      }

      // 获取HTTP方法的样式类
      function getMethodBadgeClass(method) {
        switch (method) {
          case "GET":
            return "success";
          case "POST":
            return "primary";
          case "PUT":
            return "warning";
          case "DELETE":
            return "danger";
          default:
            return "secondary";
        }
      }

      // 更新角色权限
      async function updateRolePermissions(roleId) {
        const menuIds = Array.from(
          document.querySelectorAll("#menuPermissions input:checked")
        ).map((cb) => parseInt(cb.value));

        const permissions = Array.from(
          document.querySelectorAll("#apiPermissions input:checked")
        ).map((cb) => cb.value);

        try {
          await fetchData(`/roles/${roleId}/menus`, "PUT", { menuIds });
          await fetchData(`/roles/${roleId}/permissions`, "PUT", {
            permissions,
          });
          closeModal();
          showAlert("权限更新成功", "success");
        } catch (error) {
          alert("更新权限失败: " + error.message);
        }
      }

      // 删除角色
      async function deleteRole(roleId) {
        if (!confirm("确定要删除这个角色吗？")) return;

        try {
          await fetchData(`/roles/${roleId}`, "DELETE");
          loadRoles();
          showAlert("角色删除成功", "success");
        } catch (error) {
          alert("删除角色失败: " + error.message);
        }
      }

      // 加载菜单管理页面
      async function loadMenusPage() {
        const content = document.getElementById("content");
        content.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>菜单列表</h3>
                        <button class="btn btn-success" onclick="showAddMenuModal()">添加菜单</button>
                    </div>
                    <div id="menuTree"></div>
                </div>
            `;

        await loadMenus();
      }

      // 加载菜单树
      async function loadMenus() {
        try {
          const menus = await fetchData("/menus");
          const tree = buildMenuTree(menus);
          document.getElementById("menuTree").innerHTML =
            renderMenuTreeHTML(tree);
        } catch (error) {
          document.getElementById("menuTree").innerHTML =
            '<div style="text-align: center; color: red;">加载失败</div>';
        }
      }

      // 构建菜单树
      function buildMenuTree(menus, parentId = 0) {
        return menus
          .filter((menu) => (menu.parentId || menu.parentId) === parentId)
          .map((menu) => ({
            ...menu,
            id: menu.ID || menu.id,
            children: buildMenuTree(menus, menu.ID || menu.id),
          }));
      }

      // 渲染菜单树HTML
      function renderMenuTreeHTML(tree, level = 0) {
        if (tree.length === 0) return '<p style="color: #666;">暂无菜单</p>';

        return (
          '<ul class="tree">' +
          tree
            .map(
              (item) => `
                <li class="tree-item">
                    <div style="padding-left: ${
                      level * 20
                    }px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${item.name}</strong>
                            <span style="color: #666; margin-left: 10px;">${
                              item.path || ""
                            }</span>
                            <span style="color: #999; margin-left: 10px; font-size: 12px;">${
                              item.type
                            }</span>
                        </div>
                        <div>
                            <button class="btn btn-warning btn-sm" onclick="showEditMenuModal(${
                              item.id
                            })">编辑</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteMenu(${
                              item.id
                            })">删除</button>
                        </div>
                    </div>
                    ${
                      item.children.length > 0
                        ? renderMenuTreeHTML(item.children, level + 1)
                        : ""
                    }
                </li>
            `
            )
            .join("") +
          "</ul>"
        );
      }

      // 渲染接口权限
      function renderApiPermissions(selectedPermissions = []) {
        const apiPermissions = [
          // 用户管理接口
          { id: "user:create", name: "创建用户", group: "用户管理" },
          { id: "user:read", name: "查看用户", group: "用户管理" },
          { id: "user:update", name: "更新用户", group: "用户管理" },
          { id: "user:delete", name: "删除用户", group: "用户管理" },

          // 角色管理接口
          { id: "role:create", name: "创建角色", group: "角色管理" },
          { id: "role:read", name: "查看角色", group: "角色管理" },
          { id: "role:update", name: "更新角色", group: "角色管理" },
          { id: "role:delete", name: "删除角色", group: "角色管理" },
          { id: "role:assign-menu", name: "分配菜单", group: "角色管理" },
          { id: "role:assign-permission", name: "分配权限", group: "角色管理" },

          // 菜单管理接口
          { id: "menu:create", name: "创建菜单", group: "菜单管理" },
          { id: "menu:read", name: "查看菜单", group: "菜单管理" },
          { id: "menu:update", name: "更新菜单", group: "菜单管理" },
          { id: "menu:delete", name: "删除菜单", group: "菜单管理" },
        ];

        // 按组分类
        const groupedPermissions = apiPermissions.reduce(
          (groups, permission) => {
            const group = permission.group;
            if (!groups[group]) {
              groups[group] = [];
            }
            groups[group].push(permission);
            return groups;
          },
          {}
        );

        // 生成HTML
        let html = "";
        for (const [group, permissions] of Object.entries(groupedPermissions)) {
          html += `
            <div style="margin-bottom: 15px;">
              <h5 style="margin-bottom: 10px; color: #2c3e50;">${group}</h5>
              <div style="padding-left: 20px;">
          `;

          permissions.forEach((permission) => {
            const isChecked = selectedPermissions.includes(permission.id)
              ? "checked"
              : "";
            html += `
              <label style="display: block; margin: 5px 0;">
                <input type="checkbox" name="permissions" value="${permission.id}" ${isChecked}>
                ${permission.name}
              </label>
            `;
          });

          html += `
              </div>
            </div>
          `;
        }

        document.getElementById("apiPermissions").innerHTML = html;
      }

      // 渲染菜单权限树
      function renderMenuTree(menus, selectedMenus) {
        const tree = buildMenuTree(menus);
        const html = renderMenuPermissionTreeHTML(tree, selectedMenus);
        document.getElementById("menuPermissions").innerHTML = html;
      }

      // 渲染菜单权限树HTML
      function renderMenuPermissionTreeHTML(tree, selectedMenus, level = 0) {
        return (
          '<ul class="tree">' +
          tree
            .map(
              (item) => `
                <li class="tree-item">
                    <label style="display: block; margin: 5px 0; padding-left: ${
                      level * 20
                    }px;">
                        <input type="checkbox" name="menus" value="${item.id}" 
                            ${
                              selectedMenus.some((m) => m.id === item.id)
                                ? "checked"
                                : ""
                            }>
                        ${item.name}
                    </label>
                    ${
                      item.children.length > 0
                        ? renderMenuPermissionTreeHTML(
                            item.children,
                            selectedMenus,
                            level + 1
                          )
                        : ""
                    }
                </li>
            `
            )
            .join("") +
          "</ul>"
        );
      }

      // 显示添加菜单模态框
      async function showAddMenuModal() {
        const menus = await fetchData("/menus");

        showModal(
          "添加菜单",
          `
                <form id="menuForm">
                    <div class="form-group">
                        <label>父菜单</label>
                        <select id="menuParentId" class="form-control">
                            <option value="0">顶级菜单</option>
                            ${menus
                              .map(
                                (menu) =>
                                  `<option value="${menu.id}">${menu.name}</option>`
                              )
                              .join("")}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>名称</label>
                        <input type="text" id="menuName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>路径</label>
                        <input type="text" id="menuPath" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>组件</label>
                        <input type="text" id="menuComponent" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>类型</label>
                        <select id="menuType" class="form-control">
                            <option value="Directory">目录</option>
                            <option value="Menu">菜单</option>
                            <option value="Button">按钮</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>排序</label>
                        <input type="number" id="menuSort" class="form-control" value="0">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="menuHidden"> 隐藏
                        </label>
                    </div>
                    <button type="submit" class="btn btn-success">保存</button>
                </form>
            `
        );

        document
          .getElementById("menuForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            await createMenu();
          });
      }

      // 显示编辑菜单模态框
      async function showEditMenuModal(menuId) {
        try {
          const menu = await fetchData(`/menus/${menuId}`);
          const menus = await fetchData("/menus");

          showModal(
            "编辑菜单",
            `
                    <form id="editMenuForm">
                        <div class="form-group">
                            <label>父菜单</label>
                            <select id="editMenuParentId" class="form-control">
                                <option value="0">顶级菜单</option>
                                ${menus
                                  .map(
                                    (m) =>
                                      `<option value="${m.id}" ${
                                        m.id === menu.parentId ? "selected" : ""
                                      }>${m.name}</option>`
                                  )
                                  .join("")}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>名称</label>
                            <input type="text" id="editMenuName" class="form-control" value="${
                              menu.name
                            }" required>
                        </div>
                        <div class="form-group">
                            <label>路径</label>
                            <input type="text" id="editMenuPath" class="form-control" value="${
                              menu.path || ""
                            }">
                        </div>
                        <div class="form-group">
                            <label>组件</label>
                            <input type="text" id="editMenuComponent" class="form-control" value="${
                              menu.component || ""
                            }">
                        </div>
                        <div class="form-group">
                            <label>类型</label>
                            <select id="editMenuType" class="form-control">
                                <option value="Directory" ${
                                  menu.type === "Directory" ? "selected" : ""
                                }>目录</option>
                                <option value="Menu" ${
                                  menu.type === "Menu" ? "selected" : ""
                                }>菜单</option>
                                <option value="Button" ${
                                  menu.type === "Button" ? "selected" : ""
                                }>按钮</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>排序</label>
                            <input type="number" id="editMenuSort" class="form-control" value="${
                              menu.sort
                            }">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editMenuHidden" ${
                                  menu.hidden ? "checked" : ""
                                }> 隐藏
                            </label>
                        </div>
                        <button type="submit" class="btn btn-success">保存</button>
                    </form>
                `
          );

          document
            .getElementById("editMenuForm")
            .addEventListener("submit", async function (e) {
              e.preventDefault();
              await updateMenu(menuId);
            });
        } catch (error) {
          alert("加载菜单信息失败: " + error.message);
        }
      }

      // 创建菜单
      async function createMenu() {
        const data = {
          parentId: parseInt(document.getElementById("menuParentId").value),
          name: document.getElementById("menuName").value,
          path: document.getElementById("menuPath").value,
          component: document.getElementById("menuComponent").value,
          type: document.getElementById("menuType").value,
          sort: parseInt(document.getElementById("menuSort").value),
          hidden: document.getElementById("menuHidden").checked,
        };

        try {
          await fetchData("/menus", "POST", data);
          closeModal();
          loadMenus();
          showAlert("菜单创建成功", "success");
        } catch (error) {
          alert("创建菜单失败: " + error.message);
        }
      }

      // 更新菜单
      async function updateMenu(menuId) {
        const data = {
          parentId: parseInt(document.getElementById("editMenuParentId").value),
          name: document.getElementById("editMenuName").value,
          path: document.getElementById("editMenuPath").value,
          component: document.getElementById("editMenuComponent").value,
          type: document.getElementById("editMenuType").value,
          sort: parseInt(document.getElementById("editMenuSort").value),
          hidden: document.getElementById("editMenuHidden").checked,
        };

        try {
          await fetchData(`/menus/${menuId}`, "PUT", data);
          closeModal();
          loadMenus();
          showAlert("菜单更新成功", "success");
        } catch (error) {
          alert("更新菜单失败: " + error.message);
        }
      }

      // 删除菜单
      async function deleteMenu(menuId) {
        if (!confirm("确定要删除这个菜单吗？")) return;

        try {
          await fetchData(`/menus/${menuId}`, "DELETE");
          loadMenus();
          showAlert("菜单删除成功", "success");
        } catch (error) {
          alert("删除菜单失败: " + error.message);
        }
      }

      // 加载角色复选框
      async function loadRolesForCheckboxes() {
        try {
          const roles = await fetchData("/roles");
          const html = `
            <div class="role-selection">
              ${roles
                .map(
                  (role) => `
                    <div class="role-item">
                      <input type="checkbox" name="roles" value="${role.id}" id="role-${role.id}">
                      <label for="role-${role.id}">${role.name}</label>
                    </div>
                  `
                )
                .join("")}
            </div>
          `;
          document.getElementById("roleCheckboxes").innerHTML = html;
        } catch (error) {
          console.error("加载角色失败:", error);
        }
      }

      // 工具函数
      async function fetchData(endpoint, method = "GET", data = null) {
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: currentToken ? `Bearer ${currentToken}` : "",
          },
        };

        if (data) {
          options.body = JSON.stringify(data);
        }

        const response = await fetch(`${API_BASE}${endpoint}`, options);
        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.message || "请求失败");
        }

        // 处理不同的响应格式
        // 有些接口直接返回数据，有些接口返回 { data: ... }
        return result.data !== undefined ? result.data : result;
      }

      function showModal(title, content) {
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalBody").innerHTML = content;
        document.getElementById("modal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("modal").style.display = "none";
      }

      function showAlert(message, type = "success") {
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;

        const content = document.getElementById("content");
        content.insertBefore(alert, content.firstChild);

        setTimeout(() => {
          alert.remove();
        }, 3000);
      }

      // 加载外部应用管理页面
      async function loadExternalAppsPage() {
        const content = document.getElementById("content");
        content.innerHTML = `
          <div class="card">
            <h3>外部应用管理</h3>
            <button class="btn btn-primary" onclick="showCreateExternalAppModal()">创建应用</button>
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>应用名称</th>
                  <th>应用密钥</th>
                  <th>状态</th>
                  <th>创建时间</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="externalAppsTableBody">
                <tr>
                  <td colspan="6" class="text-center">加载中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;

        await loadExternalApps();
      }

      // 加载外部应用列表
      async function loadExternalApps() {
        try {
          const apps = await fetchData("/external/apps");
          const tbody = document.getElementById("externalAppsTableBody");

          if (apps.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="text-center">暂无数据</td></tr>';
            return;
          }

          tbody.innerHTML = apps
            .map(
              (app) => `
            <tr>
              <td>${app.ID || app.id}</td>
              <td>${app.name}</td>
              <td>${app.app_key}</td>
              <td>${app.status === 1 ? "启用" : "禁用"}</td>
              <td>${formatDate(app.CreatedAt || app.createdAt)}</td>
              <td>
                <button class="btn btn-info btn-sm" onclick="showExternalAppDetailsModal(${
                  app.ID || app.id
                })">详情</button>
                <button class="btn btn-warning btn-sm" onclick="showEditExternalAppModal(${
                  app.ID || app.id
                })">编辑</button>
                <button class="btn btn-success btn-sm" onclick="generateAppToken(${
                  app.ID || app.id
                })">生成令牌</button>
                <button class="btn btn-danger btn-sm" onclick="deleteExternalApp(${
                  app.ID || app.id
                })">删除</button>
              </td>
            </tr>
          `
            )
            .join("");
        } catch (error) {
          document.getElementById("externalAppsTableBody").innerHTML =
            '<tr><td colspan="6" class="text-center">加载失败</td></tr>';
          console.error("加载外部应用列表失败:", error);
        }
      }

      // 显示创建外部应用模态框
      function showCreateExternalAppModal() {
        showModal(
          "创建外部应用",
          `
            <form id="createExternalAppForm">
              <div class="form-group">
                <label for="appName">应用名称</label>
                <input type="text" id="appName" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="appDescription">应用描述</label>
                <textarea id="appDescription" class="form-control" rows="3"></textarea>
              </div>
              <button type="submit" class="btn btn-success">创建</button>
            </form>
          `
        );

        document
          .getElementById("createExternalAppForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            await createExternalApp();
          });
      }

      // 创建外部应用
      async function createExternalApp() {
        const data = {
          name: document.getElementById("appName").value,
          description: document.getElementById("appDescription").value,
        };

        try {
          await fetchData("/external/apps", "POST", data);
          closeModal();
          loadExternalApps();
          showAlert("外部应用创建成功", "success");
        } catch (error) {
          alert("创建外部应用失败: " + error.message);
        }
      }

      // 显示外部应用详情模态框
      async function showExternalAppDetailsModal(appId) {
        try {
          const app = await fetchData(`/external/apps/${appId}`);
          const permissions = await fetchData(
            `/external/apps/${appId}/permissions`
          );

          showModal(
            `应用详情 - ${app.name}`,
            `
              <div>
                <p><strong>应用名称:</strong> ${app.name}</p>
                <p><strong>应用描述:</strong> ${app.description || "无"}</p>
                <p><strong>应用密钥:</strong> ${app.app_key}</p>
                <p><strong>状态:</strong> ${
                  app.status === 1 ? "启用" : "禁用"
                }</p>
                <p><strong>创建时间:</strong> ${formatDate(
                  app.CreatedAt || app.createdAt
                )}</p>
                
                <h4>应用权限</h4>
                <table class="table">
                  <thead>
                    <tr>
                      <th>资源</th>
                      <th>操作</th>
                      <th>描述</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${
                      permissions.length === 0
                        ? '<tr><td colspan="3" class="text-center">暂无权限</td></tr>'
                        : permissions
                            .map(
                              (p) => `
                        <tr>
                          <td>${p.resource}</td>
                          <td>${p.action}</td>
                          <td>${p.description || "无"}</td>
                        </tr>
                      `
                            )
                            .join("")
                    }
                  </tbody>
                </table>
                
                <div style="margin-top: 20px;">
                  <button class="btn btn-info" onclick="showAddPermissionModal(${appId})">添加权限</button>
                </div>
              </div>
            `
          );
        } catch (error) {
          alert("加载应用详情失败: " + error.message);
        }
      }

      // 显示添加权限模态框
      function showAddPermissionModal(appId) {
        showModal(
          "添加应用权限",
          `
            <form id="addPermissionForm">
              <div class="form-group">
                <label for="resource">资源</label>
                <select id="resource" class="form-control" required>
                  <option value="">请选择资源</option>
                  <option value="user">用户管理</option>
                  <option value="role">角色管理</option>
                  <option value="menu">菜单管理</option>
                </select>
              </div>
              <div class="form-group">
                <label for="action">操作</label>
                <select id="action" class="form-control" required>
                  <option value="">请选择操作</option>
                  <option value="create">创建</option>
                  <option value="read">读取</option>
                  <option value="update">更新</option>
                  <option value="delete">删除</option>
                  <option value="assign-menu">分配菜单</option>
                  <option value="assign-permission">分配权限</option>
                </select>
              </div>
              <div class="form-group">
                <label for="permissionDescription">权限描述</label>
                <textarea id="permissionDescription" class="form-control" rows="2"></textarea>
              </div>
              <button type="submit" class="btn btn-success">添加</button>
            </form>
          `
        );

        document
          .getElementById("addPermissionForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            await addPermission(appId);
          });
      }

      // 添加权限
      async function addPermission(appId) {
        const data = {
          app_id: appId,
          resource: document.getElementById("resource").value,
          action: document.getElementById("action").value,
          description: document.getElementById("permissionDescription").value,
        };

        try {
          await fetchData(`/external/apps/${appId}/permissions`, "POST", data);
          closeModal();
          showExternalAppDetailsModal(appId);
          showAlert("权限添加成功", "success");
        } catch (error) {
          alert("添加权限失败: " + error.message);
        }
      }

      // 生成应用令牌
      async function generateAppToken(appId) {
        if (confirm("确定要生成新的应用令牌吗？旧令牌将失效。")) {
          try {
            const result = await fetchData(
              `/external/apps/${appId}/token`,
              "POST"
            );
            alert(
              `令牌生成成功:\n${result.token}\n\n过期时间: ${new Date(
                result.expires_at
              ).toLocaleString()}`
            );
          } catch (error) {
            alert("生成令牌失败: " + error.message);
          }
        }
      }

      // 显示编辑外部应用模态框
      async function showEditExternalAppModal(appId) {
        try {
          const app = await fetchData(`/external/apps/${appId}`);

          showModal(
            "编辑外部应用",
            `
              <form id="editExternalAppForm">
                <div class="form-group">
                  <label for="editAppName">应用名称</label>
                  <input type="text" id="editAppName" class="form-control" value="${
                    app.name
                  }" required>
                </div>
                <div class="form-group">
                  <label for="editAppDescription">应用描述</label>
                  <textarea id="editAppDescription" class="form-control" rows="3">${
                    app.description || ""
                  }</textarea>
                </div>
                <div class="form-group">
                  <label for="editAppStatus">状态</label>
                  <select id="editAppStatus" class="form-control">
                    <option value="1" ${
                      app.status === 1 ? "selected" : ""
                    }>启用</option>
                    <option value="0" ${
                      app.status === 0 ? "selected" : ""
                    }>禁用</option>
                  </select>
                </div>
                <button type="submit" class="btn btn-success">保存</button>
              </form>
            `
          );

          document
            .getElementById("editExternalAppForm")
            .addEventListener("submit", async function (e) {
              e.preventDefault();
              await editExternalApp(appId);
            });
        } catch (error) {
          alert("加载应用信息失败: " + error.message);
        }
      }

      // 编辑外部应用
      async function editExternalApp(appId) {
        const data = {
          name: document.getElementById("editAppName").value,
          description: document.getElementById("editAppDescription").value,
          status: parseInt(document.getElementById("editAppStatus").value),
        };

        try {
          await fetchData(`/external/apps/${appId}`, "PUT", data);
          closeModal();
          loadExternalApps();
          showAlert("外部应用更新成功", "success");
        } catch (error) {
          alert("更新外部应用失败: " + error.message);
        }
      }

      // 删除外部应用
      async function deleteExternalApp(appId) {
        if (confirm("确定要删除这个外部应用吗？此操作不可逆。")) {
          try {
            await fetchData(`/external/apps/${appId}`, "DELETE");
            loadExternalApps();
            showAlert("外部应用删除成功", "success");
          } catch (error) {
            alert("删除外部应用失败: " + error.message);
          }
        }
      }

      // 加载外部用户管理页面
      async function loadExternalUsersPage() {
        const content = document.getElementById("content");
        content.innerHTML = `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3>外部用户管理</h3>
              <button class="btn btn-success" onclick="showAddExternalUserModal()">添加用户</button>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>应用ID</th>
                  <th>用户名</th>
                  <th>真实姓名</th>
                  <th>邮箱</th>
                  <th>手机号</th>
                  <th>状态</th>
                  <th>创建时间</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="externalUsersTableBody">
                <tr>
                  <td colspan="9" style="text-align: center;">加载中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;

        loadExternalUsers();
      }

      // 加载外部用户列表
      async function loadExternalUsers() {
        try {
          const users = await fetchData("/external/api/users");
          const tbody = document.getElementById("externalUsersTableBody");

          if (!users || users.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="9" style="text-align: center;">暂无数据</td></tr>';
            return;
          }

          tbody.innerHTML = users
            .map(
              (user) => `
            <tr>
              <td>${user.id || ""}</td>
              <td>${user.app_id || ""}</td>
              <td>${user.username || ""}</td>
              <td>${user.real_name || ""}</td>
              <td>${user.email || ""}</td>
              <td>${user.phone || ""}</td>
              <td>${user.status === 1 ? "启用" : "禁用"}</td>
              <td>${
                user.created_at
                  ? new Date(user.created_at).toLocaleString()
                  : ""
              }</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="showEditExternalUserModal(${
                  user.id
                })">编辑</button>
                <button class="btn btn-sm btn-danger" onclick="deleteExternalUser(${
                  user.id
                })">删除</button>
              </td>
            </tr>
          `
            )
            .join("");
        } catch (error) {
          console.error("加载外部用户列表失败:", error);
          document.getElementById("externalUsersTableBody").innerHTML =
            '<tr><td colspan="9" style="text-align: center;">加载失败</td></tr>';
        }
      }

      // 显示添加外部用户模态框
      function showAddExternalUserModal() {
        showModal(
          "添加外部用户",
          `
            <form id="externalUserForm">
              <div class="form-group">
                <label>应用ID</label>
                <input type="number" id="externalUserAppId" class="form-control" required>
              </div>
              <div class="form-group">
                <label>用户名</label>
                <input type="text" id="externalUserUsername" class="form-control" required>
              </div>
              <div class="form-group">
                <label>密码</label>
                <input type="password" id="externalUserPassword" class="form-control" required>
              </div>
              <div class="form-group">
                <label>真实姓名</label>
                <input type="text" id="externalUserRealName" class="form-control">
              </div>
              <div class="form-group">
                <label>邮箱</label>
                <input type="email" id="externalUserEmail" class="form-control">
              </div>
              <div class="form-group">
                <label>手机号</label>
                <input type="tel" id="externalUserPhone" class="form-control">
              </div>
              <div class="form-group">
                <label>状态</label>
                <select id="externalUserStatus" class="form-control">
                  <option value="1">启用</option>
                  <option value="0">禁用</option>
                </select>
              </div>
              <div class="form-group">
                <label>角色</label>
                <select id="externalUserRoles" class="form-control" multiple>
                </select>
              </div>
              <button type="submit" class="btn btn-success">保存</button>
            </form>
          `
        );

        loadExternalRolesForSelect();

        document
          .getElementById("externalUserForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            await createExternalUser();
          });
      }

      // 显示编辑外部用户模态框
      async function showEditExternalUserModal(userId) {
        try {
          const user = await fetchData(`/external/api/users/${userId}`);
          const roles = await fetchData("/external/api/roles");

          showModal(
            "编辑外部用户",
            `
              <form id="editExternalUserForm">
                <div class="form-group">
                  <label>用户名</label>
                  <input type="text" id="editExternalUserUsername" class="form-control" value="${
                    user.username || ""
                  }" required>
                </div>
                <div class="form-group">
                  <label>新密码（留空则不修改）</label>
                  <input type="password" id="editExternalUserPassword" class="form-control">
                </div>
                <div class="form-group">
                  <label>真实姓名</label>
                  <input type="text" id="editExternalUserRealName" class="form-control" value="${
                    user.real_name || ""
                  }">
                </div>
                <div class="form-group">
                  <label>邮箱</label>
                  <input type="email" id="editExternalUserEmail" class="form-control" value="${
                    user.email || ""
                  }">
                </div>
                <div class="form-group">
                  <label>手机号</label>
                  <input type="tel" id="editExternalUserPhone" class="form-control" value="${
                    user.phone || ""
                  }">
                </div>
                <div class="form-group">
                  <label>状态</label>
                  <select id="editExternalUserStatus" class="form-control">
                    <option value="1" ${
                      user.status === 1 ? "selected" : ""
                    }>启用</option>
                    <option value="0" ${
                      user.status === 0 ? "selected" : ""
                    }>禁用</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>角色</label>
                  <select id="editExternalUserRoles" class="form-control" multiple>
                  </select>
                </div>
                <button type="submit" class="btn btn-success">保存</button>
              </form>
            `
          );

          // 加载角色选项
          const rolesHtml = roles
            .map(
              (role) =>
                `<option value="${role.id}" ${
                  user.roles && user.roles.some((r) => r.id === role.id)
                    ? "selected"
                    : ""
                }>${role.name}</option>`
            )
            .join("");
          document.getElementById("editExternalUserRoles").innerHTML =
            rolesHtml;

          document
            .getElementById("editExternalUserForm")
            .addEventListener("submit", async function (e) {
              e.preventDefault();
              await updateExternalUser(userId);
            });
        } catch (error) {
          alert("加载用户信息失败: " + error.message);
        }
      }

      // 创建外部用户
      async function createExternalUser() {
        const selectedRoles = Array.from(
          document.getElementById("externalUserRoles").selectedOptions
        ).map((option) => parseInt(option.value));

        const data = {
          app_id: parseInt(document.getElementById("externalUserAppId").value),
          username: document.getElementById("externalUserUsername").value,
          password: document.getElementById("externalUserPassword").value,
          real_name: document.getElementById("externalUserRealName").value,
          email: document.getElementById("externalUserEmail").value,
          phone: document.getElementById("externalUserPhone").value,
          status: parseInt(document.getElementById("externalUserStatus").value),
          role_ids: selectedRoles,
        };

        try {
          await fetchData("/external/api/users", "POST", data);
          closeModal();
          loadExternalUsers();
          showAlert("外部用户创建成功", "success");
        } catch (error) {
          alert("创建外部用户失败: " + error.message);
        }
      }

      // 更新外部用户
      async function updateExternalUser(userId) {
        const selectedRoles = Array.from(
          document.getElementById("editExternalUserRoles").selectedOptions
        ).map((option) => parseInt(option.value));

        const data = {
          username: document.getElementById("editExternalUserUsername").value,
          real_name: document.getElementById("editExternalUserRealName").value,
          email: document.getElementById("editExternalUserEmail").value,
          phone: document.getElementById("editExternalUserPhone").value,
          status: parseInt(
            document.getElementById("editExternalUserStatus").value
          ),
          role_ids: selectedRoles,
        };

        const password = document.getElementById(
          "editExternalUserPassword"
        ).value;
        if (password) {
          data.password = password;
        }

        try {
          await fetchData(`/external/api/users/${userId}`, "PUT", data);
          closeModal();
          loadExternalUsers();
          showAlert("外部用户更新成功", "success");
        } catch (error) {
          alert("更新外部用户失败: " + error.message);
        }
      }

      // 删除外部用户
      async function deleteExternalUser(userId) {
        if (confirm("确定要删除这个外部用户吗？此操作不可逆。")) {
          try {
            await fetchData(`/external/api/users/${userId}`, "DELETE");
            loadExternalUsers();
            showAlert("外部用户删除成功", "success");
          } catch (error) {
            alert("删除外部用户失败: " + error.message);
          }
        }
      }

      // 加载外部角色选项
      async function loadExternalRolesForSelect() {
        try {
          const roles = await fetchData("/external/api/roles");
          const html = roles
            .map((role) => `<option value="${role.id}">${role.name}</option>`)
            .join("");
          document.getElementById("externalUserRoles").innerHTML = html;
        } catch (error) {
          console.error("加载外部角色失败:", error);
        }
      }

      // 加载接口文档页面
      async function loadApiDocsPage() {
        const content = document.getElementById("content");
        content.innerHTML = `
          <div class="card">
            <h3>API 接口文档</h3>
            <div class="api-docs">
              <h4>认证相关</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>接口</th>
                    <th>方法</th>
                    <th>路径</th>
                    <th>描述</th>
                    <th>请求参数</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>用户登录</td>
                    <td>POST</td>
                    <td>/login</td>
                    <td>用户登录获取令牌</td>
                    <td>username, password</td>
                  </tr>
                  <tr>
                    <td>用户登出</td>
                    <td>POST</td>
                    <td>/logout</td>
                    <td>用户登出</td>
                    <td>无</td>
                  </tr>
                </tbody>
              </table>

              <h4>权限检查</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>接口</th>
                    <th>方法</th>
                    <th>路径</th>
                    <th>描述</th>
                    <th>请求参数</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>检查权限</td>
                    <td>POST</td>
                    <td>/api/v1/check</td>
                    <td>检查用户是否有特定权限</td>
                    <td>resource, action</td>
                  </tr>
                  <tr>
                    <td>获取用户导航</td>
                    <td>GET</td>
                    <td>/api/v1/user/nav</td>
                    <td>获取用户可访问的导航菜单</td>
                    <td>无</td>
                  </tr>
                </tbody>
              </table>

              <h4>用户管理</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>接口</th>
                    <th>方法</th>
                    <th>路径</th>
                    <th>描述</th>
                    <th>请求参数</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>创建用户</td>
                    <td>POST</td>
                    <td>/api/v1/users</td>
                    <td>创建新用户</td>
                    <td>username, password, status, roles</td>
                  </tr>
                  <tr>
                    <td>获取用户列表</td>
                    <td>GET</td>
                    <td>/api/v1/users</td>
                    <td>获取所有用户列表</td>
                    <td>无</td>
                  </tr>
                  <tr>
                    <td>获取用户详情</td>
                    <td>GET</td>
                    <td>/api/v1/users/:id</td>
                    <td>根据ID获取用户详情</td>
                    <td>id (路径参数)</td>
                  </tr>
                  <tr>
                    <td>更新用户</td>
                    <td>PUT</td>
                    <td>/api/v1/users/:id</td>
                    <td>更新用户信息</td>
                    <td>id (路径参数), username, password, status, roles</td>
                  </tr>
                  <tr>
                    <td>删除用户</td>
                    <td>DELETE</td>
                    <td>/api/v1/users/:id</td>
                    <td>删除用户</td>
                    <td>id (路径参数)</td>
                  </tr>
                </tbody>
              </table>

              <h4>角色管理</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>接口</th>
                    <th>方法</th>
                    <th>路径</th>
                    <th>描述</th>
                    <th>请求参数</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>创建角色</td>
                    <td>POST</td>
                    <td>/api/v1/roles</td>
                    <td>创建新角色</td>
                    <td>code, name, sort</td>
                  </tr>
                  <tr>
                    <td>获取角色列表</td>
                    <td>GET</td>
                    <td>/api/v1/roles</td>
                    <td>获取所有角色列表</td>
                    <td>无</td>
                  </tr>
                  <tr>
                    <td>获取角色详情</td>
                    <td>GET</td>
                    <td>/api/v1/roles/:id</td>
                    <td>根据ID获取角色详情</td>
                    <td>id (路径参数)</td>
                  </tr>
                  <tr>
                    <td>更新角色</td>
                    <td>PUT</td>
                    <td>/api/v1/roles/:id</td>
                    <td>更新角色信息</td>
                    <td>id (路径参数), code, name, sort</td>
                  </tr>
                  <tr>
                    <td>删除角色</td>
                    <td>DELETE</td>
                    <td>/api/v1/roles/:id</td>
                    <td>删除角色</td>
                    <td>id (路径参数)</td>
                  </tr>
                  <tr>
                    <td>分配菜单</td>
                    <td>POST</td>
                    <td>/api/v1/roles/:id/menus</td>
                    <td>为角色分配菜单</td>
                    <td>id (路径参数), menuIds</td>
                  </tr>
                  <tr>
                    <td>分配权限</td>
                    <td>POST</td>
                    <td>/api/v1/roles/:id/permissions</td>
                    <td>为角色分配权限</td>
                    <td>id (路径参数), permissions</td>
                  </tr>
                </tbody>
              </table>

              <h4>菜单管理</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>接口</th>
                    <th>方法</th>
                    <th>路径</th>
                    <th>描述</th>
                    <th>请求参数</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>创建菜单</td>
                    <td>POST</td>
                    <td>/api/v1/menus</td>
                    <td>创建新菜单</td>
                    <td>parentId, name, path, component, type, sort, hidden</td>
                  </tr>
                  <tr>
                    <td>获取菜单列表</td>
                    <td>GET</td>
                    <td>/api/v1/menus</td>
                    <td>获取所有菜单列表（扁平结构）</td>
                    <td>无</td>
                  </tr>
                  <tr>
                    <td>获取菜单树</td>
                    <td>GET</td>
                    <td>/api/v1/menus/tree</td>
                    <td>获取菜单树结构</td>
                    <td>无</td>
                  </tr>
                  <tr>
                    <td>获取菜单详情</td>
                    <td>GET</td>
                    <td>/api/v1/menus/:id</td>
                    <td>根据ID获取菜单详情</td>
                    <td>id (路径参数)</td>
                  </tr>
                  <tr>
                    <td>更新菜单</td>
                    <td>PUT</td>
                    <td>/api/v1/menus/:id</td>
                    <td>更新菜单信息</td>
                    <td>id (路径参数), parentId, name, path, component, type, sort, hidden</td>
                  </tr>
                  <tr>
                    <td>删除菜单</td>
                    <td>DELETE</td>
                    <td>/api/v1/menus/:id</td>
                    <td>删除菜单</td>
                    <td>id (路径参数)</td>
                  </tr>
                </tbody>
              </table>

              <h4>外部应用管理</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>接口</th>
                    <th>方法</th>
                    <th>路径</th>
                    <th>描述</th>
                    <th>请求参数</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>注册应用</td>
                    <td>POST</td>
                    <td>/external/register</td>
                    <td>外部系统注册应用</td>
                    <td>name, description</td>
                  </tr>
                  <tr>
                    <td>获取令牌</td>
                    <td>POST</td>
                    <td>/external/token</td>
                    <td>使用应用密钥获取访问令牌</td>
                    <td>app_key, app_secret</td>
                  </tr>
                  <tr>
                    <td>创建应用</td>
                    <td>POST</td>
                    <td>/api/v1/external/apps</td>
                    <td>创建外部应用</td>
                    <td>name, description</td>
                  </tr>
                  <tr>
                    <td>获取应用列表</td>
                    <td>GET</td>
                    <td>/api/v1/external/apps</td>
                    <td>获取所有外部应用列表</td>
                    <td>无</td>
                  </tr>
                  <tr>
                    <td>获取应用详情</td>
                    <td>GET</td>
                    <td>/api/v1/external/apps/:id</td>
                    <td>根据ID获取应用详情</td>
                    <td>id (路径参数)</td>
                  </tr>
                  <tr>
                    <td>更新应用</td>
                    <td>PUT</td>
                    <td>/api/v1/external/apps/:id</td>
                    <td>更新应用信息</td>
                    <td>id (路径参数), name, description, status</td>
                  </tr>
                  <tr>
                    <td>删除应用</td>
                    <td>DELETE</td>
                    <td>/api/v1/external/apps/:id</td>
                    <td>删除应用</td>
                    <td>id (路径参数)</td>
                  </tr>
                  <tr>
                    <td>生成应用令牌</td>
                    <td>POST</td>
                    <td>/api/v1/external/apps/:id/token</td>
                    <td>为应用生成新的访问令牌</td>
                    <td>id (路径参数)</td>
                  </tr>
                  <tr>
                    <td>创建应用权限</td>
                    <td>POST</td>
                    <td>/api/v1/external/apps/:id/permissions</td>
                    <td>为应用创建权限</td>
                    <td>id (路径参数), resource, action, description</td>
                  </tr>
                  <tr>
                    <td>获取应用权限</td>
                    <td>GET</td>
                    <td>/api/v1/external/apps/:id/permissions</td>
                    <td>获取应用权限列表</td>
                    <td>id (路径参数)</td>
                  </tr>
                  <tr>
                    <td>更新应用权限</td>
                    <td>PUT</td>
                    <td>/api/v1/external/apps/permissions/:id</td>
                    <td>更新应用权限</td>
                    <td>id (路径参数), resource, action, description</td>
                  </tr>
                  <tr>
                    <td>删除应用权限</td>
                    <td>DELETE</td>
                    <td>/api/v1/external/apps/permissions/:id</td>
                    <td>删除应用权限</td>
                    <td>id (路径参数)</td>
                  </tr>
                </tbody>
              </table>

              <h4>外部API (需要应用令牌认证)</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>接口</th>
                    <th>方法</th>
                    <th>路径</th>
                    <th>描述</th>
                    <th>请求参数</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>获取菜单列表</td>
                    <td>GET</td>
                    <td>/external/api/menus</td>
                    <td>获取所有菜单列表</td>
                    <td>Authorization: Bearer &lt;token&gt;</td>
                  </tr>
                  <tr>
                    <td>创建菜单</td>
                    <td>POST</td>
                    <td>/external/api/menus</td>
                    <td>创建新菜单</td>
                    <td>Authorization: Bearer &lt;token&gt;, parentId, name, path, component, type, sort, hidden</td>
                  </tr>
                  <tr>
                    <td>更新菜单</td>
                    <td>PUT</td>
                    <td>/external/api/menus/:id</td>
                    <td>更新菜单信息</td>
                    <td>Authorization: Bearer &lt;token&gt;, id (路径参数), parentId, name, path, component, type, sort, hidden</td>
                  </tr>
                  <tr>
                    <td>删除菜单</td>
                    <td>DELETE</td>
                    <td>/external/api/menus/:id</td>
                    <td>删除菜单</td>
                    <td>Authorization: Bearer &lt;token&gt;, id (路径参数)</td>
                  </tr>
                  <tr>
                    <td>分配菜单权限</td>
                    <td>POST</td>
                    <td>/external/api/roles/:id/menus</td>
                    <td>为角色分配菜单权限</td>
                    <td>Authorization: Bearer &lt;token&gt;, id (路径参数), role_id, menu_ids</td>
                  </tr>
                  <tr>
                    <td>分配API权限</td>
                    <td>POST</td>
                    <td>/external/api/roles/:id/permissions</td>
                    <td>为角色分配API权限</td>
                    <td>Authorization: Bearer &lt;token&gt;, id (路径参数), role_id, permissions</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString("zh-CN");
      }
    </script>
  </body>
</html>
