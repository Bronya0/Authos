import{m as ae,r as E,d as j}from"./index-C99W1-_y.js";import{k as W,r as d,I as J,f as m,O as ee,o as X,w as i,e as l,i as N,G as r,n as Q,a as oe,y as le,l as se,c as re,d as Y,h as S,J as z,B as M,N as V,Q as Z}from"./index-Bh7ncf5g.js";import{f as ie}from"./format-CL3lqu5w.js";import{_ as ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{A as de}from"./Add-DH5gGSs4.js";import{C as ce,T as pe}from"./Trash-AESF4UkK.js";import{L as fe}from"./List-ANkTgYCm.js";import{K as me}from"./Key-Cuo-08Zj.js";const ve={__name:"RoleMenuModal",props:{visible:{type:Boolean,default:!1},roleId:{type:[String,Number],default:null},roleName:{type:String,default:""}},emits:["update:visible","saved"],setup(G,{emit:P}){const y=G,D=P,g=W(),c=n=>Array.isArray(n)?n.map(e=>({ID:e.ID||e.id,name:e.name||e.Name,type:e.type||e.Type,parentId:e.parentId||e.ParentID,path:e.path||e.Path,component:e.component||e.Component,sort:e.sort||e.Sort,hidden:e.hidden||e.Hidden,isSystem:e.isSystem||e.IsSystem,children:e.children&&e.children.length>0?c(e.children):[]})):[],v=d(!1),_=d(!1),w=d(!1),f=d([]),h=d([]),b=d([]),A=n=>{let e=[];return n.forEach(s=>{e.push(s.ID),s.children&&s.children.length>0&&(e=e.concat(A(s.children)))}),e},x=n=>{let e=[];return n.children&&n.children.length>0&&n.children.forEach(s=>{e.push(s.ID),e=e.concat(x(s))}),e},$=(n,e)=>{for(const s of n){if(s.ID===e)return s;if(s.children&&s.children.length>0){const u=$(s.children,e);if(u)return u}}return null};J(()=>y.visible,n=>{v.value=n,n&&y.roleId&&(B(),k())}),J(v,n=>{D("update:visible",n)});const B=async()=>{_.value=!0;try{const n=await ae.getMenuTree(),e=c(n||[]);f.value=e,b.value=A(e)}catch{g.showError("加载菜单列表失败")}finally{_.value=!1}},k=async()=>{try{const n=await E.getRoleMenus(y.roleId),e=c(n||[]);h.value=e.map(s=>s.ID)}catch{g.showError("加载角色菜单失败")}},L=(n,e,s)=>{if(s.action==="check"){const u=$(f.value,s.node.ID);if(u){const C=x(u);h.value=[...new Set([...n,...C])]}else h.value=n}else if(s.action==="uncheck"){const u=x(s.node);h.value=n.filter(C=>!u.includes(C))}else h.value=n},q=async()=>{w.value=!0;try{await E.updateRoleMenus(y.roleId,{menuIds:h.value}),g.showSuccess("菜单权限分配成功"),v.value=!1,D("saved")}catch(n){g.showError(n.message||"菜单权限分配失败")}finally{w.value=!1}},o=()=>{h.value=[]};return(n,e)=>{const s=m("n-tree"),u=m("n-spin"),C=m("n-button"),H=m("n-space"),O=m("n-drawer-content"),F=m("n-drawer");return X(),ee(F,{show:v.value,"onUpdate:show":e[2]||(e[2]=K=>v.value=K),width:500,placement:"right",onAfterLeave:o},{default:i(()=>[l(O,{title:"菜单权限分配",closable:""},{footer:i(()=>[l(H,{justify:"end"},{default:i(()=>[l(C,{onClick:e[1]||(e[1]=K=>v.value=!1)},{default:i(()=>[...e[3]||(e[3]=[N("取消",-1)])]),_:1}),l(C,{type:"primary",loading:w.value,onClick:q},{default:i(()=>[...e[4]||(e[4]=[N(" 保存 ",-1)])]),_:1},8,["loading"])]),_:1})]),default:i(()=>[l(u,{show:_.value},{default:i(()=>[l(s,{data:f.value,"checked-keys":h.value,"on-update:checked-keys":L,"expand-on-click":!0,selectable:!1,checkable:!0,"show-line":!0,indent:20,cascade:!1,"expanded-keys":b.value,"onUpdate:expandedKeys":e[0]||(e[0]=K=>b.value=K),"block-line":"","key-field":"ID","label-field":"name","children-field":"children"},null,8,["data","checked-keys","expanded-keys"])]),_:1},8,["show"])]),_:1})]),_:1},8,["show"])}}},ye={__name:"RoleApiPermissionModal",props:{visible:{type:Boolean,default:!1},roleUUID:{type:String,default:""},roleName:{type:String,default:""}},emits:["update:visible","saved"],setup(G,{emit:P}){const y=G,D=P,g=W(),c=d(!1),v=d(!1),_=d(!1),w=d([]),f=d([]);J(()=>y.visible,o=>{c.value=o,o&&y.roleUUID&&($(),B())}),J(c,o=>{D("update:visible",o)});const h=o=>({"*":"primary",GET:"success",POST:"info",PUT:"warning",DELETE:"error",PATCH:"default",HEAD:"default",OPTIONS:"default"})[o]||"default",b=[{type:"selection"},{title:"权限名称",key:"name",width:200},{title:"接口路径",key:"path",width:250},{title:"HTTP方法",key:"method",width:120,render:o=>r(Q,{type:h(o.method)},()=>o.method==="*"?"全部":o.method)},{title:"描述",key:"description"}],A={pageSize:10},x=o=>o.uuid||o.UUID,$=async()=>{v.value=!0;try{const o=await j.getApiPermissions();w.value=o||[]}catch{g.showError("加载接口权限列表失败")}finally{v.value=!1}},B=async()=>{try{const o=await j.getApiPermissionsForRole(y.roleUUID);o&&Array.isArray(o)?f.value=o.map(n=>n.uuid||n.UUID):f.value=[]}catch{g.showError("加载角色接口权限失败"),f.value=[]}},k=o=>{f.value=o},L=async()=>{_.value=!0;try{const o=await j.getApiPermissionsForRole(y.roleUUID),n=o&&Array.isArray(o)?o.map(u=>u.uuid||u.UUID):[],e=f.value.filter(u=>!n.includes(u)),s=n.filter(u=>!f.value.includes(u));for(const u of e)await j.addApiPermissionToRole(y.roleUUID,{permissionUUID:u});for(const u of s)await j.removeApiPermissionFromRole(y.roleUUID,{permissionUUID:u});g.showSuccess("接口权限分配成功"),c.value=!1,D("saved")}catch(o){g.showError(o.message||"接口权限分配失败")}finally{_.value=!1}},q=()=>{f.value=[]};return(o,n)=>{const e=m("n-data-table"),s=m("n-spin"),u=m("n-button"),C=m("n-space"),H=m("n-drawer-content"),O=m("n-drawer");return X(),ee(O,{show:c.value,"onUpdate:show":n[1]||(n[1]=F=>c.value=F),width:800,placement:"right",onAfterLeave:q},{default:i(()=>[l(H,{title:"接口权限分配",closable:""},{footer:i(()=>[l(C,{justify:"end"},{default:i(()=>[l(u,{onClick:n[0]||(n[0]=F=>c.value=!1)},{default:i(()=>[...n[2]||(n[2]=[N("取消",-1)])]),_:1}),l(u,{type:"primary",loading:_.value,onClick:L},{default:i(()=>[...n[3]||(n[3]=[N(" 保存 ",-1)])]),_:1},8,["loading"])]),_:1})]),default:i(()=>[l(s,{show:v.value},{default:i(()=>[l(e,{columns:b,data:w.value,"row-key":x,"checked-row-keys":f.value,"onUpdate:checkedRowKeys":k,pagination:A},null,8,["data","checked-row-keys"])]),_:1},8,["show"])]),_:1})]),_:1},8,["show"])}}},he={style:{display:"flex","justify-content":"space-between","align-items":"center"}},ge={__name:"Roles",setup(G){const P=W(),y=d([]),D=d(!1),g=d(!1),c=d(!1),v=d(!1),_=d(null),w=d(""),f=d(""),h=d(!1),b=d(!1),A=d(""),x=()=>{e()},$=()=>{A.value="",e()},B=d(),k=oe({name:""}),L={name:[{required:!0,message:"请输入角色名称",trigger:"blur"}]},q=le({get:()=>c.value&&!v.value,set:t=>{t?(v.value=!1,c.value=!0):c.value=!1}}),o=[{title:"ID",key:"id",width:80,render:t=>t.ID||t.id},{title:"名称",key:"name",width:150},{title:"菜单权限",key:"menuCount",width:250,render(t){if(!t.menuCount||t.menuCount===0)return r("span",{style:"color: #ccc"},"无菜单权限");if(!t.menuPreview||t.menuPreview.length===0)return r("span",{style:"color: #18a058"},`${t.menuCount} 个菜单`);const a=t.menuPreview.map(p=>r(Q,{size:"small"},{default:()=>p})),U=r(z,{size:[4,4]},{default:()=>a});return t.menuCount>3?r(z,{align:"center",size:4},{default:()=>[U,r(Z,{trigger:"hover"},{trigger:()=>r("span",{style:"font-size: 12px; color: #18a058; cursor: pointer; white-space: nowrap"},`等 ${t.menuCount} 个...`),default:()=>"点击“菜单”按钮查看详情"})]}):U}},{title:"接口权限",key:"apiPermCount",width:250,render(t){if(!t.apiPermCount||t.apiPermCount===0)return r("span",{style:"color: #ccc"},"无接口权限");if(!t.apiPermPreview||t.apiPermPreview.length===0)return r("span",{style:"color: #2080f0"},`${t.apiPermCount} 个接口`);const a=t.apiPermPreview.map(p=>r(Q,{size:"small",type:"info"},{default:()=>p})),U=r(z,{size:[4,4]},{default:()=>a});return t.apiPermCount>3?r(z,{align:"center",size:4},{default:()=>[U,r(Z,{trigger:"hover"},{trigger:()=>r("span",{style:"font-size: 12px; color: #2080f0; cursor: pointer; white-space: nowrap"},`等 ${t.apiPermCount} 个...`),default:()=>"点击“权限”按钮查看详情"})]}):U}},{title:"创建时间",key:"CreatedAt",width:180,render:t=>ie(t.CreatedAt)},{title:"操作",key:"actions",width:250,render:t=>r(z,null,{default:()=>[r(M,{size:"small",type:"warning",quaternary:!0,onClick:()=>u(t)},{default:()=>"编辑",icon:()=>r(V,null,{default:()=>r(ce)})}),r(M,{size:"small",type:"error",quaternary:!0,onClick:()=>{confirm("确定要删除该角色吗？")&&H(t)}},{default:()=>"删除",icon:()=>r(V,null,{default:()=>r(pe)})}),r(M,{size:"small",type:"info",quaternary:!0,onClick:()=>O(t)},{default:()=>"菜单",icon:()=>r(V,null,{default:()=>r(fe)})}),r(M,{size:"small",type:"info",quaternary:!0,onClick:()=>F(t)},{default:()=>"权限",icon:()=>r(V,null,{default:()=>r(me)})})]})}],n={pageSize:10},e=async()=>{D.value=!0;try{const t=await E.getRoles({name:A.value});y.value=t,await s(t)}catch{P.showError("加载角色列表失败")}finally{D.value=!1}},s=async t=>{try{const a=t.map(async p=>{const T=p.ID||p.id;try{const R=await E.getRoleMenusCount(T);p.menuCount=R,p.menuPreview=[]}catch(R){console.error(`获取角色${T}的菜单数量失败:`,R),p.menuCount=0,p.menuPreview=[]}}),U=t.map(async p=>{const T=p.ID||p.id;try{const R=await E.getRoleApiPermissionsCount(T);p.apiPermCount=R,p.apiPermPreview=[]}catch(R){console.error(`获取角色${T}的接口权限数量失败:`,R),p.apiPermCount=0,p.apiPermPreview=[]}});await Promise.all([...a,...U])}catch(a){console.error("加载角色权限数量失败:",a)}},u=t=>{v.value=!0,_.value=t.ID||t.id,w.value=t.uuid||t.UUID||"",k.name=t.name,c.value=!0},C=async()=>{var t;try{await((t=B.value)==null?void 0:t.validate()),g.value=!0;const a={name:k.name};v.value?(await E.updateRole(_.value,a),P.showSuccess("角色更新成功")):(await E.createRole(a),P.showSuccess("角色创建成功")),c.value=!1,e()}catch(a){P.showError(a.message||"保存失败")}finally{g.value=!1}},H=async t=>{try{const a=t.ID||t.id;await E.deleteRole(a),P.showSuccess("角色删除成功"),e()}catch{P.showError("删除失败")}},O=t=>{_.value=t.ID||t.id,f.value=t.name||t.Name,h.value=!0},F=t=>{w.value=t.uuid||t.UUID,f.value=t.name||t.Name,b.value=!0},K=()=>{k.name="",v.value=!1,_.value=null,w.value="",f.value=""};return se(()=>{e()}),(t,a)=>{const U=m("n-input"),p=m("n-data-table"),T=m("n-card"),R=m("n-form-item"),te=m("n-form"),ne=m("n-modal");return X(),re("div",null,[l(T,null,{header:i(()=>[Y("div",he,[l(S(z),{align:"center"},{default:i(()=>[a[8]||(a[8]=Y("span",null,"角色列表",-1)),l(U,{value:A.value,"onUpdate:value":[a[0]||(a[0]=I=>A.value=I),x],placeholder:"搜索角色名称",clearable:"",style:{width:"200px"}},null,8,["value"]),l(S(M),{onClick:$},{default:i(()=>[...a[7]||(a[7]=[N("重置",-1)])]),_:1})]),_:1}),l(S(M),{type:"primary",onClick:a[1]||(a[1]=I=>q.value=!0)},{icon:i(()=>[l(S(V),null,{default:i(()=>[l(S(de))]),_:1})]),default:i(()=>[a[9]||(a[9]=N(" 添加角色 ",-1))]),_:1})])]),default:i(()=>[l(p,{columns:o,data:y.value,loading:D.value,pagination:n},null,8,["data","loading"])]),_:1}),l(ne,{show:c.value,"onUpdate:show":a[4]||(a[4]=I=>c.value=I),title:v.value?"编辑角色":"添加角色",preset:"dialog","show-icon":!1,onAfterLeave:K},{action:i(()=>[l(S(z),null,{default:i(()=>[l(S(M),{onClick:a[3]||(a[3]=I=>c.value=!1)},{default:i(()=>[...a[10]||(a[10]=[N("取消",-1)])]),_:1}),l(S(M),{type:"primary",loading:g.value,onClick:C},{default:i(()=>[...a[11]||(a[11]=[N(" 保存 ",-1)])]),_:1},8,["loading"])]),_:1})]),default:i(()=>[l(te,{ref_key:"formRef",ref:B,model:k,rules:L,"label-placement":"left","label-width":"80px"},{default:i(()=>[l(R,{label:"名称",path:"name"},{default:i(()=>[l(U,{value:k.name,"onUpdate:value":a[2]||(a[2]=I=>k.name=I),placeholder:"请输入角色名称"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),l(ve,{visible:h.value,"onUpdate:visible":a[5]||(a[5]=I=>h.value=I),"role-id":_.value,"role-name":f.value,onSaved:e},null,8,["visible","role-id","role-name"]),l(ye,{visible:b.value,"onUpdate:visible":a[6]||(a[6]=I=>b.value=I),"role-u-u-i-d":w.value,"role-name":f.value,onSaved:e},null,8,["visible","role-u-u-i-d","role-name"])])}}},be=ue(ge,[["__scopeId","data-v-1ca54598"]]);export{be as default};
