import{u as k,r as W}from"./index-C99W1-_y.js";import{k as X,u as Y,r as d,a as Z,y as R,l as ee,c as ae,e as t,w as l,f as i,o as te,G as o,d as B,h as v,J as b,B as w,i as g,N as C,n as T}from"./index-Bh7ncf5g.js";import{f as le,a as se,g as ne}from"./format-CL3lqu5w.js";import{_ as oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{A as re}from"./Add-DH5gGSs4.js";import{C as ue,T as de}from"./Trash-AESF4UkK.js";const ie={style:{display:"flex","justify-content":"space-between","align-items":"center"}},pe={__name:"Users",setup(ve){const f=X();Y();const x=d([]),D=d([]),U=d(!1),S=d(!1),p=d(!1),u=d(!1),A=d(null),m=Z({username:"",status:null}),E=()=>{_()},q=()=>{m.username="",m.status=null,_()},z=d(),s=d({username:"",password:"",status:1,roleIds:[]}),M={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,validator:(a,e)=>!u.value&&!e?new Error("请输入密码"):!0,trigger:"blur"}]},P=R(()=>D.value.map(a=>({label:a.name,value:a.id||a.ID}))),V=R({get:()=>p.value&&!u.value,set:a=>{a?(u.value=!1,p.value=!0):p.value=!1}}),$=[{title:"ID",key:"id",width:80,render:a=>a.ID||a.id},{title:"用户名",key:"username"},{title:"状态",key:"status",width:100,render:a=>o(T,{type:ne(a.status)},{default:()=>se(a.status)})},{title:"角色",key:"roles",width:250,render:a=>{const e=a.roles||[];if(e.length===0)return o("span",{style:"color: #ccc"},"无角色");const r=e.slice(0,3).map(y=>o(T,{type:"info",size:"small",round:!0},{default:()=>y.name})),c=o(b,{size:[4,4]},{default:()=>r});return e.length>3?o(b,{align:"center",size:4},{default:()=>[c,o("span",{style:"font-size: 12px; color: #999; white-space: nowrap"},`等 ${e.length} 个`)]}):c}},{title:"创建时间",key:"createdAt",width:180,render:a=>le(a.CreatedAt||a.createdAt)},{title:"操作",key:"actions",width:200,render:a=>o(b,null,{default:()=>[o(w,{size:"small",type:"warning",quaternary:!0,onClick:()=>G(a)},{default:()=>"编辑",icon:()=>o(C,null,{default:()=>o(ue)})}),o(w,{size:"small",type:"error",quaternary:!0,onClick:()=>{confirm("确定要删除该用户吗？")&&L(a)}},{default:()=>"删除",icon:()=>o(C,null,{default:()=>o(de)})})]})}],j={pageSize:10},_=async()=>{U.value=!0;try{const a=await k.getUsers(m);x.value=a}catch{f.showError("加载用户列表失败")}finally{U.value=!1}},F=async()=>{try{const a=await W.getRoles();D.value=a}catch{f.showError("加载角色列表失败")}},G=a=>{u.value=!0,A.value=a.ID||a.id,s.value.username=a.username,s.value.status=a.status,s.value.password="";const e=(a.roles||[]).filter(r=>r).map(r=>r.ID||r.id);s.value.roleIds=e,p.value=!0},J=async()=>{var a;try{await((a=z.value)==null?void 0:a.validate()),S.value=!0;const{username:e,status:r,roleIds:c,password:y}=s.value,h={username:e,status:r,roleIds:c};y&&(h.password=y),u.value?(await k.updateUser(A.value,h),f.showSuccess("用户更新成功")):(await k.createUser(h),f.showSuccess("用户创建成功")),p.value=!1,_()}catch(e){f.showError(e.message||"保存失败")}finally{S.value=!1}},L=async a=>{try{const e=a.ID||a.id;await k.deleteUser(e),f.showSuccess("用户删除成功"),_()}catch{f.showError("删除失败")}},O=()=>{s.value.username="",s.value.password="",s.value.status=1,s.value.roleIds=[],u.value=!1,A.value=null};return ee(()=>{_(),F()}),(a,e)=>{const r=i("n-input"),c=i("n-select"),y=i("n-data-table"),h=i("n-card"),I=i("n-form-item"),N=i("n-radio"),H=i("n-radio-group"),K=i("n-form"),Q=i("n-modal");return te(),ae("div",null,[t(h,null,{header:l(()=>[B("div",ie,[t(v(b),{align:"center"},{default:l(()=>[e[10]||(e[10]=B("span",null,"用户列表",-1)),t(r,{value:m.username,"onUpdate:value":[e[0]||(e[0]=n=>m.username=n),E],placeholder:"搜索用户名",clearable:"",style:{width:"200px"}},null,8,["value"]),t(c,{value:m.status,"onUpdate:value":[e[1]||(e[1]=n=>m.status=n),E],placeholder:"状态",clearable:"",options:[{label:"启用",value:1},{label:"禁用",value:0}],style:{width:"120px"}},null,8,["value"]),t(v(w),{onClick:q},{default:l(()=>[...e[9]||(e[9]=[g("重置",-1)])]),_:1})]),_:1}),t(v(w),{type:"primary",onClick:e[2]||(e[2]=n=>V.value=!0)},{icon:l(()=>[t(v(C),null,{default:l(()=>[t(v(re))]),_:1})]),default:l(()=>[e[11]||(e[11]=g(" 添加用户 ",-1))]),_:1})])]),default:l(()=>[t(y,{columns:$,data:x.value,loading:U.value,pagination:j},null,8,["data","loading"])]),_:1}),t(Q,{show:p.value,"onUpdate:show":e[8]||(e[8]=n=>p.value=n),title:u.value?"编辑用户":"添加用户",preset:"dialog","show-icon":!1,onAfterLeave:O},{action:l(()=>[t(v(b),null,{default:l(()=>[t(v(w),{onClick:e[7]||(e[7]=n=>p.value=!1)},{default:l(()=>[...e[14]||(e[14]=[g("取消",-1)])]),_:1}),t(v(w),{type:"primary",loading:S.value,onClick:J},{default:l(()=>[...e[15]||(e[15]=[g(" 保存 ",-1)])]),_:1},8,["loading"])]),_:1})]),default:l(()=>[t(K,{ref_key:"formRef",ref:z,model:s.value,rules:M,"label-placement":"left","label-width":"80px"},{default:l(()=>[t(I,{label:"用户名",path:"username"},{default:l(()=>[t(r,{value:s.value.username,"onUpdate:value":e[3]||(e[3]=n=>s.value.username=n),disabled:u.value,placeholder:"请输入用户名"},null,8,["value","disabled"])]),_:1}),t(I,{label:u.value?"新密码":"密码",path:"password"},{default:l(()=>[t(r,{value:s.value.password,"onUpdate:value":e[4]||(e[4]=n=>s.value.password=n),type:"password",placeholder:u.value?"留空不修改":"请输入密码"},null,8,["value","placeholder"])]),_:1},8,["label"]),t(I,{label:"状态",path:"status"},{default:l(()=>[t(H,{value:s.value.status,"onUpdate:value":e[5]||(e[5]=n=>s.value.status=n)},{default:l(()=>[t(N,{value:1},{default:l(()=>[...e[12]||(e[12]=[g("启用",-1)])]),_:1}),t(N,{value:0},{default:l(()=>[...e[13]||(e[13]=[g("禁用",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),t(I,{label:"角色",path:"roleIds"},{default:l(()=>[t(c,{value:s.value.roleIds,"onUpdate:value":e[6]||(e[6]=n=>s.value.roleIds=n),multiple:"",placeholder:"请选择角色",options:P.value},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])])}}},_e=oe(pe,[["__scopeId","data-v-183834ba"]]);export{_e as default};
